# 瀛州纪 - 新功能测试指南

> 碎片收藏系统 & 纪元系统测试说明

---

## 🎯 新增功能概览

### 1. 记忆碎片收藏界面 📚
- 18格网格展示所有碎片（8个主要 + 10个隐藏）
- 实时进度追踪
- 按纪元筛选
- 碎片详情查看

### 2. 纪元系统面板 🌌
- 五大纪元时间线可视化
- 当前纪元信息展示
- 纪元推进条件追踪
- 一键推进功能

### 3. 标签页导航
- 三个标签页：AI对话、记忆碎片、纪元系统
- 无缝切换，状态保持

---

## 🚀 快速开始

### 第一步：部署智能合约

在 `瀛州纪` 目录下运行：

```bash
npm run deploy:auto
```

**这个命令会**：
1. 部署所有智能合约（包括新的 EpochManager 和 MemoryFragment）
2. 自动更新 `.env.local` 文件
3. 配置合约之间的授权关系
4. 导出 ABI 文件到 `lib/abis/` 目录

**预期输出**：
```
🚀 开始自动化部署瀛州纪智能合约...
✅ WorldLedger 部署到: 0x...
✅ DigitalBeing 部署到: 0x...
✅ AINPC 部署到: 0x...
✅ Resource1155 部署到: 0x...
✅ Market 部署到: 0x...
✅ EpochManager 部署到: 0x...
✅ MemoryFragment 部署到: 0x...
🎉 部署完成！
```

### 第二步：启动开发服务器

```bash
npm run dev
```

访问：http://localhost:3000

### 第三步：连接钱包和创建数字生命

1. 点击"连接钱包"按钮
2. 在 MetaMask 中批准连接
3. 确保连接到 Hardhat Local 网络（Chain ID: 31337）
4. 点击"创建数字生命"按钮
5. 等待交易确认

---

## 📝 功能测试清单

### 测试 1：记忆碎片收藏界面

#### 步骤：
1. 创建数字生命后，点击"🌀 进入管理面板"（或通过3D传送门进入2D面板）
2. 点击"📚 记忆碎片"标签页

#### 应该看到：
- [ ] 18个碎片格子排列整齐
- [ ] 所有碎片显示为"?"（未获得状态）
- [ ] 进度条显示：主要碎片 0/8，隐藏碎片 0/10
- [ ] 筛选按钮：全部、创世、萌芽、繁盛、熵化、毁灭

#### 测试筛选功能：
- [ ] 点击"创世纪元"按钮，应该只显示该纪元的碎片
- [ ] 点击"萌芽纪元"按钮，应该切换显示
- [ ] 点击"全部"按钮，应该显示所有18个碎片

#### 查看碎片详情：
- [ ] 点击任意未获得的碎片，不应有反应（因为未获得）
- [ ] （当获得碎片后）点击已获得的碎片，应该弹出详情窗口
- [ ] 详情窗口应显示：标题、内容、纪元、触发关键词

### 测试 2：纪元系统面板

#### 步骤：
1. 在2D面板中，点击"🌌 纪元系统"标签页

#### 应该看到：
- [ ] 当前纪元：创世纪元（🌌）
- [ ] 纪元描述："混沌初开，数字生命觉醒"
- [ ] 五大纪元时间线（创世高亮，其他灰色）
- [ ] 推进条件区域

#### 查看推进条件：
- [ ] 显示"推进到萌芽纪元 🌱"
- [ ] 显示碎片收集进度：0 / 1
- [ ] 进度条为黄色（未满足）
- [ ] 推进按钮显示"🔒 条件未满足"，且为灰色不可点击

#### 测试纪元推进（需要先获得碎片）：
- [ ] 当收集到1个碎片后，进度条变为绿色
- [ ] 推进按钮变为可点击状态
- [ ] 点击推进按钮，触发交易
- [ ] 交易确认后，纪元应切换到"萌芽"
- [ ] 时间线中"萌芽"节点应高亮

### 测试 3：标签页切换

#### 步骤：
1. 在2D面板中，依次点击三个标签页

#### 应该看到：
- [ ] 点击"💬 AI对话"：显示NPC列表和对话界面
- [ ] 点击"📚 记忆碎片"：显示碎片收藏界面
- [ ] 点击"🌌 纪元系统"：显示纪元面板
- [ ] 标签切换流畅，无闪烁或卡顿
- [ ] 切换标签时，状态保持（如选中的NPC、筛选条件等）

### 测试 4：3D场景集成

#### 步骤：
1. 在2D面板中完成测试后，点击"🌌 进入3D区块链实体世界"
2. 进入3D场景

#### 应该看到：
- [ ] 3D场景正常加载
- [ ] 可以通过中央传送门返回2D面板
- [ ] 返回2D面板后，碎片和纪元数据保持一致

---

## 🧪 测试碎片铸造（开发者功能）

### 方法 1：通过管理员脚本铸造

创建测试脚本 `scripts/test-mint-fragment.js`：

```javascript
const hre = require("hardhat");

async function main() {
  // 获取部署者账户
  const [deployer] = await hre.ethers.getSigners();
  console.log("使用账户:", deployer.address);

  // 获取 MemoryFragment 合约
  const memoryFragmentAddress = process.env.NEXT_PUBLIC_MEMORY_FRAGMENT_ADDRESS;
  const MemoryFragment = await hre.ethers.getContractAt("MemoryFragment", memoryFragmentAddress);

  // 铸造碎片 #0 给部署者
  console.log("正在铸造碎片 #0...");
  const tx = await MemoryFragment.mint(deployer.address, 0, 1, "0x");
  await tx.wait();
  
  console.log("✅ 碎片 #0 铸造成功！");
  
  // 验证余额
  const balance = await MemoryFragment.balanceOf(deployer.address, 0);
  console.log("当前余额:", balance.toString());
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

运行：
```bash
npx hardhat run scripts/test-mint-fragment.js --network localhost
```

### 方法 2：通过前端调试面板

在 `/debug` 页面添加测试按钮（TODO）。

---

## 🎨 视觉检查清单

### 纪元颜色系统
- [ ] 创世纪元：青色 (#00FFFF)
- [ ] 萌芽纪元：绿色 (#00FF00)
- [ ] 繁盛纪元：黄色 (#FFFF00)
- [ ] 熵化纪元：红色 (#FF0000)
- [ ] 毁灭纪元：白色 (#FFFFFF)

### 碎片稀有度标识
- [ ] 主要碎片：蓝色菱形 🔷
- [ ] 隐藏碎片：橙色菱形 🔶

### 动画效果
- [ ] 进度条填充动画流畅
- [ ] 按钮悬停效果正常
- [ ] 碎片点击有反馈
- [ ] 弹窗出现/消失有过渡

---

## ❌ 常见问题排查

### 问题 1：找不到合约地址

**症状**：页面显示"合约地址未配置"

**解决**：
1. 确认 `.env.local` 文件存在
2. 确认文件中包含 `NEXT_PUBLIC_EPOCH_MANAGER_ADDRESS` 和 `NEXT_PUBLIC_MEMORY_FRAGMENT_ADDRESS`
3. 重启开发服务器：`Ctrl+C` 然后 `npm run dev`

### 问题 2：碎片显示为空

**症状**：碎片收藏界面显示"加载失败"

**可能原因**：
1. ABI 文件未生成（需要先部署合约）
2. 合约未正确部署
3. 网络不匹配

**解决**：
1. 重新运行 `npm run deploy:auto`
2. 检查浏览器控制台的错误信息
3. 确认 MetaMask 连接到 Hardhat Local (Chain ID: 31337)

### 问题 3：纪元推进按钮不可用

**症状**：收集了碎片但推进按钮仍为灰色

**可能原因**：
1. 碎片数量未达到要求
2. 前端缓存未更新
3. 合约状态未同步

**解决**：
1. 刷新页面（F5）
2. 清除浏览器缓存
3. 检查合约中的碎片余额

### 问题 4：3D场景无法加载

**症状**：点击"进入3D世界"后黑屏

**解决**：
1. 检查浏览器控制台的CSP错误
2. 确认 `next.config.js` 已正确配置
3. 尝试刷新页面

---

## 📊 测试结果记录表

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 碎片界面加载 | ⏸️ 待测试 | |
| 碎片筛选功能 | ⏸️ 待测试 | |
| 纪元面板显示 | ⏸️ 待测试 | |
| 纪元时间线 | ⏸️ 待测试 | |
| 标签页切换 | ⏸️ 待测试 | |
| 3D场景集成 | ⏸️ 待测试 | |
| 颜色主题系统 | ⏸️ 待测试 | |
| 响应式布局 | ⏸️ 待测试 | |

---

## 🎉 测试完成后

如果所有测试通过，你已经成功完成了：

1. ✅ 记忆碎片收藏系统
2. ✅ 纪元系统UI
3. ✅ 标签页导航
4. ✅ 3D/2D场景集成

**下一步可以做什么？**

- 🎮 开发小游戏组件
- 🤖 升级AI对话系统（纪元感知）
- 🎨 实现3D场景纪元颜色切换
- 🔑 实现关键词触发系统

---

**祝测试顺利！** 🚀

有任何问题，请查看 `开发进度汇总-2025-11-08.md` 或 `游戏系统实施指南.md`。

