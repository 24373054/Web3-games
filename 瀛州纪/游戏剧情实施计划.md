# ç€›å·çºª - æ¸¸æˆå‰§æƒ…å®æ–½è®¡åˆ’

## ğŸ“‹ å®æ–½é˜¶æ®µæ¦‚è§ˆ

åŸºäº `æ¸¸æˆå‰§æƒ….md` çš„å®Œæ•´è®¾å®šï¼Œæœ¬è®¡åˆ’å°†åˆ†**ä¸‰ä¸ªé˜¶æ®µ**é€æ­¥å®ç°æ¸¸æˆç³»ç»Ÿã€‚

---

## ğŸ¯ é˜¶æ®µä¸€ï¼šæ ¸å¿ƒæ¶æ„æ­å»ºï¼ˆç¬¬1-2å‘¨ï¼‰

### 1.1 çºªå…ƒç³»ç»Ÿæ™ºèƒ½åˆçº¦ â³

**æ–‡ä»¶**: `contracts/EpochManager.sol`

**åŠŸèƒ½éœ€æ±‚**:
```solidity
contract EpochManager {
    enum Epoch { Genesis, Emergence, Flourish, Entropy, Destruction }
    
    struct EpochState {
        Epoch currentEpoch;
        uint256 startBlock;
        uint256 endBlock;
        uint256 harmonyLevel;  // 0-100
        uint256 populationCount;
        bool isActive;
    }
    
    // å…³é”®åŠŸèƒ½
    - getCurrentEpoch() - è·å–å½“å‰çºªå…ƒ
    - canAdvanceEpoch(address player) - æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¨è¿›æ¡ä»¶
    - advanceEpoch(address player) - æ¨è¿›åˆ°ä¸‹ä¸€çºªå…ƒ
    - getEpochParams() - è·å–å½“å‰çºªå…ƒå‚æ•°ï¼ˆé¢œè‰²ã€ç¯å¢ƒç­‰ï¼‰
}
```

**æ¨è¿›æ¡ä»¶**:
- åˆ›ä¸– â†’ èŒèŠ½: 1ä¸ªç¢ç‰‡ + ä¸å²å®˜å¯¹è¯
- èŒèŠ½ â†’ ç¹ç››: 3ä¸ªç¢ç‰‡ + ä¸å²å®˜å’Œå•†åºå¯¹è¯
- ç¹ç›› â†’ ç†µåŒ–: 5ä¸ªç¢ç‰‡ + ä¸å²å®˜ã€å·¥åŒ å¯¹è¯
- ç†µåŒ– â†’ æ¯ç­: 7ä¸ªç¢ç‰‡ + ä¸é—å¿˜è€…å¯¹è¯

### 1.2 è®°å¿†ç¢ç‰‡NFTç³»ç»Ÿ ğŸ’

**æ–‡ä»¶**: `contracts/MemoryFragment.sol`

**åŠŸèƒ½éœ€æ±‚**:
```solidity
contract MemoryFragment is ERC721 {
    struct Fragment {
        uint8 fragmentId;      // 1-18
        string title;
        uint256 blockNumber;
        string content;
        bool isHidden;         // ä¸»è¦ç¢ç‰‡ vs éšè—ç¢ç‰‡
        Epoch epoch;
    }
    
    // ç¢ç‰‡æ€»æ•°ï¼š8ä¸ªä¸»è¦ + 10ä¸ªéšè— = 18ä¸ª
    mapping(uint256 => Fragment) public fragments;
    mapping(address => uint256[]) public playerFragments;
    
    // å…³é”®åŠŸèƒ½
    - mintFragment(address player, uint8 fragmentId)
    - getPlayerFragments(address player) returns (Fragment[])
    - getTotalProgress(address player) returns (uint8 main, uint8 hidden)
}
```

**ç¢ç‰‡åˆ—è¡¨**:
| ID | åç§° | ç±»å‹ | çºªå…ƒ | è·å–æ–¹å¼ |
|----|------|------|------|----------|
| 1 | åˆ›ä¸–ä¹‹å…‰ | ä¸»è¦ | åˆ›ä¸– | å²å®˜å°æ¸¸æˆ |
| 2 | æ¡æ‰‹åè®® | ä¸»è¦ | èŒèŠ½ | å²å®˜å°æ¸¸æˆ |
| 3 | ä¿¡ä»»çš„ä»£ç  | ä¸»è¦ | èŒèŠ½ | å•†åºå°æ¸¸æˆ |
| 4 | ä»£ç è¯—æ­Œ | ä¸»è¦ | ç¹ç›› | å²å®˜å¯¹è¯ |
| 5 | å®Œç¾çš„ä»£ä»· | ä¸»è¦ | ç¹ç›› | å·¥åŒ å°æ¸¸æˆ |
| 6 | é¢„è¨€çš„æ‚–è®º | ä¸»è¦ | ç†µåŒ– | å…ˆçŸ¥å°æ¸¸æˆ |
| 7 | ç†µçš„å¿…ç„¶æ€§ | ä¸»è¦ | ç†µåŒ– | é—å¿˜è€…å¯¹è¯ |
| 8 | æœ€åçš„å‡½æ•° | ä¸»è¦ | æ¯ç­ | ç»ˆç« è§¦å‘ |
| 9-18 | éšè—ç¢ç‰‡ | éšè— | å„çºªå…ƒ | å…³é”®è¯è§¦å‘ |

### 1.3 æ‰©å±•DigitalBeingåˆçº¦ ğŸ¤–

**æ–‡ä»¶**: `contracts/DigitalBeing.sol`

**æ–°å¢å­—æ®µ**:
```solidity
struct Being {
    // ... ç°æœ‰å­—æ®µ
    uint8 currentEpoch;           // å½“å‰æ‰€åœ¨çºªå…ƒ
    uint256[] collectedFragments; // æ”¶é›†çš„ç¢ç‰‡ID
    uint256 totalInteractions;    // æ€»äº¤äº’æ¬¡æ•°
    mapping(uint8 => bool) npcMetStatus; // é‡è§è¿‡çš„NPC
}

// æ–°å¢åŠŸèƒ½
function getProgress(uint256 beingId) external view returns (
    uint8 epoch,
    uint8 fragmentsCollected,
    uint8 npcsMet
);
```

---

## ğŸ® é˜¶æ®µäºŒï¼šå°æ¸¸æˆä¸AIå¯¹è¯ç³»ç»Ÿï¼ˆç¬¬3-4å‘¨ï¼‰

### 2.1 å°æ¸¸æˆåˆçº¦ç³»ç»Ÿ ğŸ¯

**æ–‡ä»¶**: `contracts/MiniGameManager.sol`

**6ä¸ªå°æ¸¸æˆç±»å‹**:

1. **è®°å¿†æ’åº** (å²å®˜)
   ```solidity
   struct MemorySortGame {
       uint256[] blocks;      // éœ€è¦æ’åºçš„åŒºå—å·
       uint256[] playerAnswer;
       uint256 timeSpent;
       uint8 accuracy;        // 0-100
   }
   ```

2. **æ¡æ‰‹åè®®** (å²å®˜-èŒèŠ½)
   ```solidity
   struct HandshakeGame {
       address[] nodes;       // éœ€è¦è¿æ¥çš„èŠ‚ç‚¹
       bytes32[] connections; // ç©å®¶çš„è¿æ¥
       uint256 timeLimit;
   }
   ```

3. **èµ„æºå¹³è¡¡** (å•†åº)
   ```solidity
   struct BalanceGame {
       uint256[5] nodeBalances;
       uint256 maintainTime;  // ç»´æŒå¹³è¡¡çš„æ—¶é—´
       uint8 stability;       // ç¨³å®šæ€§è¯„åˆ†
   }
   ```

4. **ä»£ç æ„å»º** (å·¥åŒ )
   ```solidity
   struct BuildGame {
       bytes32[] blocks;      // 3Dä¿„ç½—æ–¯æ–¹å—
       uint8 height;
       uint8 completeness;
   }
   ```

5. **æœªæ¥æ¨æ¼”** (å…ˆçŸ¥)
   ```solidity
   struct PredictionGame {
       bytes32[] patterns;
       bytes32[] predictions;
       uint8 correctCount;
   }
   ```

6. **æ··æ²Œè¿·å®«** (é—å¿˜è€…)
   ```solidity
   struct MazeGame {
       bytes32 mazeHash;
       uint256 escapeTime;
       bool escaped;
   }
   ```

**å®Œæˆåº¦è®¡ç®—**:
```solidity
function calculateCompletionRate(
    uint256 timeSpent,
    uint256 timeLimit,
    uint8 accuracy,
    uint8 mistakes
) public pure returns (uint8) {
    uint8 timeScore = (timeSpent < timeLimit) ? 40 : 0;
    uint8 accuracyScore = (accuracy * 40) / 100;
    uint8 fluentScore = max(0, 20 - mistakes * 5);
    return timeScore + accuracyScore + fluentScore;
}
```

### 2.2 AIå¯¹è¯ç³»ç»Ÿå‡çº§ ğŸ’¬

**æ–‡ä»¶**: `app/api/ai-chat-enhanced/route.ts`

**æ–°å¢åŠŸèƒ½**:

1. **çºªå…ƒæ„ŸçŸ¥**
   ```typescript
   const systemPrompt = `
   ä½ æ˜¯${npcName}ï¼Œå½“å‰å¤„äº${epochName}çºªå…ƒã€‚
   
   çºªå…ƒç‰¹å¾ï¼š${epochDescription}
   ä½ çš„è®°å¿†ï¼š${npcMemories}
   ä½ çš„çŠ¶æ€ï¼š${npcState}
   
   å¯¹è¯é£æ ¼éœ€è¦åæ˜ å½“å‰çºªå…ƒçš„æ°›å›´...
   `
   ```

2. **å…³é”®è¯æ£€æµ‹**
   ```typescript
   const keywordTriggers = {
     'åˆ›ä¸–': ['å­˜åœ¨çš„è¯æ˜', 'åˆ›é€ è€…', 'Block 0'],
     'èŒèŠ½': ['æ¡æ‰‹', 'ä¿¡ä»»', 'require'],
     'ç¹ç››': ['ä»£ç è¯—æ­Œ', 'å®Œç¾', 'è‰ºæœ¯'],
     'ç†µåŒ–': ['é—å¿˜', 'å®¿å‘½', 'ç†µ', 'æ··æ²Œ'],
     'æ¯ç­': ['ç»ˆç»“', 'æ°¸æ’', 'è´¦æœ¬']
   };
   
   function detectKeywords(message: string, epoch: string) {
     const triggers = keywordTriggers[epoch];
     return triggers.some(kw => message.includes(kw));
   }
   ```

3. **éšè—ç¢ç‰‡å¥–åŠ±**
   ```typescript
   if (keywordDetected) {
     await memoryFragmentContract.mintFragment(
       player,
       hiddenFragmentId
     );
     return {
       message: "ï¼è§¦å‘éšè—è®°å¿†ï¼ä½ æ‰¾åˆ°äº†å…³é”®...",
       fragmentUnlocked: true
     };
   }
   ```

---

## ğŸŒˆ é˜¶æ®µä¸‰ï¼šå‰ç«¯è§†è§‰ä¸ä½“éªŒä¼˜åŒ–ï¼ˆç¬¬5-6å‘¨ï¼‰

### 3.1 çºªå…ƒè§†è§‰ç³»ç»Ÿ ğŸ¨

**æ–‡ä»¶**: `components/Scene3D/EpochVisuals.tsx`

**5ç§çºªå…ƒé…è‰²æ–¹æ¡ˆ**:

```typescript
const epochThemes = {
  Genesis: {
    clearColor: [0.02, 0.02, 0.1, 1],    // æ·±è“ç´«
    bubbleColor: [0.1, 0.15, 0.4],
    emissiveColor: [0.15, 0.25, 0.5],
    particleColor: [0.3, 0.5, 1, 0.6],
    ambientIntensity: 0.3,
    fogDensity: 0.01
  },
  Emergence: {
    clearColor: [0.05, 0.15, 0.1, 1],    // é’ç»¿è‰²
    bubbleColor: [0.2, 0.4, 0.3],
    emissiveColor: [0.3, 0.6, 0.4],
    particleColor: [0.4, 1, 0.6, 0.7],
    ambientIntensity: 0.5,
    fogDensity: 0.005
  },
  Flourish: {
    clearColor: [0.2, 0.15, 0.02, 1],    // é‡‘é»„è‰²
    bubbleColor: [0.6, 0.5, 0.2],
    emissiveColor: [1, 0.8, 0.3],
    particleColor: [1, 0.9, 0.4, 0.8],
    ambientIntensity: 0.8,
    fogDensity: 0
  },
  Entropy: {
    clearColor: [0.15, 0.05, 0.05, 1],   // æš—çº¢ç°
    bubbleColor: [0.4, 0.2, 0.2],
    emissiveColor: [0.8, 0.3, 0.3],
    particleColor: [1, 0.3, 0.3, 0.5],
    ambientIntensity: 0.4,
    fogDensity: 0.02,
    glitchEffect: true
  },
  Destruction: {
    clearColor: [0.05, 0.05, 0.05, 1],   // é»‘ç™½ç°
    bubbleColor: [0.3, 0.3, 0.3],
    emissiveColor: [0.5, 0.5, 0.5],
    particleColor: [0.7, 0.7, 0.7, 0.3],
    ambientIntensity: 0.2,
    fogDensity: 0.03,
    freezeEffect: true
  }
};
```

**è½¬åœºåŠ¨ç”»**:
```typescript
function transitionToEpoch(newEpoch: Epoch, duration: number) {
  // 1. å±å¹•æ·¡å‡º
  fadeOut(500);
  
  // 2. åˆ‡æ¢é¢œè‰²ä¸»é¢˜ï¼ˆlerpæ’å€¼ï¼‰
  setTimeout(() => {
    lerpColors(currentTheme, newTheme, duration);
  }, 500);
  
  // 3. é‡æ–°ç”Ÿæˆç¯å¢ƒå…ƒç´ 
  setTimeout(() => {
    recreateEnvironment(newEpoch);
  }, 1000);
  
  // 4. å±å¹•æ·¡å…¥
  setTimeout(() => {
    fadeIn(500);
  }, 1500);
}
```

### 3.2 è®°å¿†ç¢ç‰‡æ”¶è—ç•Œé¢ ğŸ“š

**æ–‡ä»¶**: `components/FragmentGallery.tsx`

**åŠŸèƒ½**:
- 18æ ¼ç½‘æ ¼å±•ç¤º
- æœªè·å¾—ç¢ç‰‡æ˜¾ç¤ºä¸ºæš—å½±è½®å»“
- ç‚¹å‡»å·²è·å¾—ç¢ç‰‡æŸ¥çœ‹è¯¦æƒ…ï¼ˆæ ‡é¢˜ã€åŒºå—å·ã€å®Œæ•´å†…å®¹ï¼‰
- è¿›åº¦ç»Ÿè®¡ï¼šä¸»è¦ç¢ç‰‡ X/8ï¼Œéšè—ç¢ç‰‡ Y/10
- æŒ‰çºªå…ƒåˆ†ç±»å±•ç¤º

### 3.3 å°æ¸¸æˆUIç»„ä»¶ ğŸ²

**6ä¸ªå°æ¸¸æˆç»„ä»¶**:

1. `components/MiniGames/MemorySort.tsx` - æ‹–æ‹½æ’åº
2. `components/MiniGames/HandshakeProtocol.tsx` - è¿çº¿æ¸¸æˆ
3. `components/MiniGames/ResourceBalance.tsx` - å¹³è¡¡è°ƒèŠ‚
4. `components/MiniGames/CodeBuilder.tsx` - 3Dä¿„ç½—æ–¯æ–¹å—
5. `components/MiniGames/FuturePrediction.tsx` - æ¨¡å¼é¢„æµ‹
6. `components/MiniGames/ChaosMaze.tsx` - è¿·å®«é€ƒè„±

æ¯ä¸ªç»„ä»¶åŒ…å«ï¼š
- æ¸¸æˆé€»è¾‘
- å€’è®¡æ—¶
- å®Œæˆåº¦å®æ—¶æ˜¾ç¤º
- ç»“ç®—ç•Œé¢

### 3.4 è¿›åº¦è¿½è¸ªé¢æ¿ ğŸ“Š

**æ–‡ä»¶**: `components/ProgressPanel.tsx`

**æ˜¾ç¤ºå†…å®¹**:
```typescript
interface PlayerProgress {
  currentEpoch: string;
  fragmentsCollected: {
    main: number;    // X/8
    hidden: number;  // Y/10
    total: number;   // Z/18
  };
  npcDialogues: {
    archivist: number;
    architect: number;
    mercantile: number;
    oracle: number;
    entropy: number;
  };
  miniGameScores: {
    [gameName: string]: {
      attempts: number;
      bestScore: number;
      completed: boolean;
    };
  };
}
```

---

## ğŸš€ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¼€å§‹ï¼‰
1. âœ… EpochManager åˆçº¦
2. âœ… MemoryFragment åˆçº¦
3. âœ… æ‰©å±• AINPC å¯¹è¯æ”¯æŒçºªå…ƒæ„ŸçŸ¥

### ä¸­ä¼˜å…ˆçº§ï¼ˆç¬¬2-3å‘¨ï¼‰
4. âœ… MiniGameManager åˆçº¦
5. âœ… AIå¯¹è¯å…³é”®è¯æ£€æµ‹
6. âœ… å‰ç«¯çºªå…ƒåˆ‡æ¢UI

### ä½ä¼˜å…ˆçº§ï¼ˆç¬¬4-6å‘¨ï¼‰
7. âœ… 6ä¸ªå°æ¸¸æˆå‰ç«¯å®ç°
8. âœ… è®°å¿†ç¢ç‰‡å±•ç¤ºç•Œé¢
9. âœ… 3Dåœºæ™¯çºªå…ƒè§†è§‰æ•ˆæœ
10. âœ… å®Œæ•´çš„è¿›åº¦è¿½è¸ªç³»ç»Ÿ

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### æ™ºèƒ½åˆçº¦è®¾è®¡åŸåˆ™
- ä½¿ç”¨äº‹ä»¶è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
- çºªå…ƒæ•°æ®å­˜å‚¨é“¾ä¸Šï¼Œè§†è§‰æ•ˆæœå­˜å‚¨é“¾ä¸‹
- ç¢ç‰‡é“¸é€ æƒé™æ§åˆ¶ï¼ˆåªèƒ½é€šè¿‡ç‰¹å®šæµç¨‹è·å¾—ï¼‰
- Gasä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ã€ç¼“å­˜å¸¸ç”¨æ•°æ®

### å‰ç«¯å®ç°è¦ç‚¹
- React çŠ¶æ€ç®¡ç†ï¼šçºªå…ƒã€ç¢ç‰‡ã€è¿›åº¦
- 3Dåœºæ™¯åŠ¨æ€è°ƒæ•´ï¼šé¢œè‰²ã€ç²’å­ã€å…‰æ•ˆ
- å°æ¸¸æˆç‹¬ç«‹ç»„ä»¶åŒ–ï¼Œä¾¿äºç»´æŠ¤
- ç¦»çº¿ç¼“å­˜ï¼šå·²è·å¾—ç¢ç‰‡çš„å†…å®¹

### AIå¯¹è¯ç­–ç•¥
- ä¸ºæ¯ä¸ªNPCå‡†å¤‡5ä¸ªçºªå…ƒçš„ä¸åŒprompt
- å…³é”®è¯åº“é¢„å…ˆå®šä¹‰ï¼Œå®æ—¶åŒ¹é…
- å¯¹è¯å†å²å½±å“åç»­å›ç­”
- çºªå…ƒæ°›å›´åœ¨è¯­æ°”å’Œæªè¾ä¸­ä½“ç°

---

## ğŸ¯ é‡Œç¨‹ç¢‘

- **Week 1-2**: åˆçº¦éƒ¨ç½²å®Œæˆï¼ŒåŸºç¡€çºªå…ƒåˆ‡æ¢å¯ç”¨
- **Week 3-4**: AIå¯¹è¯å‡çº§å®Œæˆï¼Œè‡³å°‘3ä¸ªå°æ¸¸æˆå¯ç©
- **Week 5-6**: è§†è§‰æ•ˆæœå®Œå–„ï¼Œæ‰€æœ‰åŠŸèƒ½é›†æˆ

---

## ğŸ’¡ åˆ›æ–°ç‚¹

1. **é“¾ä¸Šå‰§æƒ…æ¨è¿›** - çºªå…ƒåˆ‡æ¢å®Œå…¨ç”±åŒºå—é“¾çŠ¶æ€é©±åŠ¨
2. **NFTå™äº‹** - æ¯ä¸ªç¢ç‰‡æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•…äº‹ç‰‡æ®µ
3. **åŠ¨æ€AI** - NPCå¯¹è¯éšçºªå…ƒå˜åŒ–è€Œæ”¹å˜æ€§æ ¼
4. **æ²‰æµ¸å¼è½¬åœº** - 3Dè§†è§‰å®Œç¾é…åˆå‰§æƒ…æ°›å›´
5. **å¤šç»“å±€å¯èƒ½** - æ ¹æ®ç¢ç‰‡æ”¶é›†æƒ…å†µè§£é”ä¸åŒç»“å±€

---

è®©æˆ‘ä»¬å¼€å§‹å®æ–½ç¬¬ä¸€æ­¥ï¼šåˆ›å»º EpochManager åˆçº¦ï¼ğŸš€

